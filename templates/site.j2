# {{ ansible_managed }}

    server {
        
        listen 443 ssl http2;

        server_name www.{{ item.site }};

        return 301 https://{{ item.site }};

        {% if item.nginx.ssl == 1 %}

        ssl on;
        ssl_certificate /etc/ssl/nginx/{{ item.site }}/{{ item.site }}.pem;
        ssl_certificate_key /etc/ssl/nginx/{{ item.site }}/{{ item.site }}.key;

        {% endif %}

    }

    server {

        listen 443 ssl http2;

        server_tokens off;

        charset utf-8;
		
        # server names for this server.
        # any requests that come in that match any these names will use the proxy.
        server_name {{ item.site }};

        root /home/{{ item.site }};

        {% if item.nginx.ssl == 1 %}

        ssl on;
        ssl_certificate /etc/ssl/nginx/{{ item.site }}/{{ item.site }}.pem;
        ssl_certificate_key /etc/ssl/nginx/{{ item.site }}/{{ item.site }}.key;
        ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
        ssl_prefer_server_ciphers on;
        ssl_dhparam /etc/ssl/certs/dhparam.pem;

        {% endif %}

        #Access Logs
        access_log /var/log/nginx/{{ item.site }}.access.log;
        
        #Error Logs
        error_log /var/log/nginx/{{ item.site }}.error.log;

        {% include "default/status.j2" %}        

        {% include "default/header.j2" %}

        location = /favicon.ico { access_log off; log_not_found off; }
        location = /robots.txt  { access_log off; log_not_found off; }

        location / {

            {% if item.nginx.wordpress == 1 %}

                {% if item.nginx.memcached == 1 %}

            location / {
                error_page 404 405 = @nocache;
                
                if ($query_string = true){
                    return 405;
                }
                if ($request_method = POST){
                    return 405;
                }
                if ($request_uri ~ "/wp-"){
                    return 405;
                }
                if ($http_cookie ~ (wp-postpass|wordpress_logged_in|comment_author)_ ){
                    return 405;
                }
                
                default_type text/html;
                add_header X-Powered-By Cachify;
                set $memcached_key $http_host$uri;
                memcached_pass localhost:11211;
            }
                {% else %}
                
            try_files $cache_enabler_uri $uri $uri/ $custom_subdir/index.php?$args;

                {% endif %}        
            {% else %}

            return 301 https://sbaerlo.ch/er;
            add_header  X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";

            {% endif %}
        }

        {%  if item.nginx.php == 1  %}

            {% include "app/php.j2" %}

        {% endif %}

        {% if item.nginx.hhvm == 1 %}

            {% include "app/hhvm.j2" %}

        {% endif %}

        {%  if item.nginx.wordpress == 1  %}
 
        {% include "app/wordpress.j2" %}

        {% endif %}  

        
        {% include "default/error.j2" %}
    
        {% include "default/cache.j2" %}
    }

{% if item.alias is defined %}
#####################################################################################
#################################### Alias ##########################################
#####################################################################################

    {% for alias in item.alias %}

        {% if item.alias is defined %}

        server {
        
        listen 443 ssl http2;

        server_name www.{{ alias }};

        return 301 https://{{ alias }};

        {% if item.nginx.ssl == 1 %}

        ssl on;
        ssl_certificate /etc/ssl/nginx/{{ item.site }}/{{ alias }}.pem;
        ssl_certificate_key /etc/ssl/nginx/{{ item.site }}/{{ alias }}.key;

        {% endif %}

        {% endif %}

    }

    server {

        listen 443 ssl http2;

        server_tokens off;
        
        # server names for this server.
        # any requests that come in that match any these names will use the proxy.
        server_name {{ alias }};

        root /home/{{ item.site }};

        {% if item.nginx.ssl == 1 %}

        ssl on;
        ssl_certificate /etc/ssl/nginx/{{ item.site }}/{{ alias }}.pem;
        ssl_certificate_key /etc/ssl/nginx/{{ item.site }}/{{ alias }}.key;

        {% endif %}

        #Access Logs
        access_log /var/log/nginx/{{ alias }}.access.log;
        
        #Error Logs
        error_log /var/log/nginx/{{ alias }}.error.log;

        {% include "default/status.j2" %}   

        {% include "default/header.j2" %}

        location / {

            {% if item.nginx.wordpress == 1 %}

            try_files $cache_enabler_uri $uri $uri/ $custom_subdir/index.php?$args;

            {% else %}

            return 301 https://sbaerlo.ch/er;
            add_header  X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";

            {% endif %}
        }

        {%  if item.nginx.php == 1  %}

            {% include "app/php.j2" %}

        {% endif %}

        {% if item.nginx.hhvm == 1 %}

            {% include "app/hhvm.j2" %}

        {% endif %}

        {%  if item.nginx.wordpress == 1  %}
 
        {% include "app/wordpress.j2" %}

        {% endif %}  
    
        {% include "default/error.j2" %}

        {% include "default/cache.j2" %}

    }
    {% endfor %}

{% endif %}