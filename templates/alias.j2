# {{ ansible_managed }}

    server {
        
        listen 443 ssl http2;

        server_name www.{{ item.alias }};

        return 301 https://{{ item.alias }};

        {% if item.nginx.ssl == 1 %}

        ssl on;
        ssl_certificate /etc/ssl/nginx/{{ item.site }}/{{ item.alias }}.pem;
        ssl_certificate_key /etc/ssl/nginx/{{ item.site }}/{{ item.alias }}.key;

        {% endif %}

    }

    server {

        listen 443 ssl http2;

        server_tokens off;
		
        # server names for this server.
        # any requests that come in that match any these names will use the proxy.
        server_name {{ item.alias }};

        root /home/{{ item.site }};

        {% if item.nginx.ssl == 1 %}

        ssl on;
        ssl_certificate /etc/ssl/nginx/{{ item.site }}/{{ item.alias }}.pem;
        ssl_certificate_key /etc/ssl/nginx/{{ item.site }}/{{ item.alias }}.key;

        {% endif %}

        #Access Logs
        access_log /var/log/nginx/{{ item.alias }}.access.log;
        
        #Error Logs
        error_log /var/log/nginx/{{ item.alias }}.error.log;

        #default headers
        #X-XSS-Protection
        add_header x-xss-protection "1; mode=block" always;
        #X-Frame-Options
        add_header x-frame-options "SAMEORIGIN" always;
        #X-Content-Type-Options
        add_header X-Content-Type-Options "nosniff" always;
        #Content-Security-Policy
        #add_header Content-Security-Policy "default-src 'self'; img-src *;font-src *;";
        #Strict-Transport-Security
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        location / {

            {% if item.nginx.cdn == 1 %}

            return 301 https://sbaerlo.ch/er;
            add_header  X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";

            {% elif item.nginx.wordpress == 1 %}

            try_files $uri $uri/ /index.php?$args;

            {% endif %}
        }
        
        location /status {
            stub_status on;
            allow 62.113.202.39;
            deny all;
        }
 
        {% if item.nginx.cdn == 1 %}
        location ~ ^/files/(.*)$ {
            alias /home/{{ item.site }}/wp-content/uploads/$1;
            expires max;
            add_header Pragma public;
            add_header Cache-Control "public, must-revalidate, proxy-revalidate";
        }
 
        {% endif %}
        {%  if item.nginx.php == 1  %}
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_index index.php;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_intercept_errors on;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_pass unix:/var/run/php-fpm/{{ item.site }}.sock;
            fastcgi_param  HTTPS on;
            include fastcgi_params;
        }

        {% endif %}
        {% if item.nginx.hhvm == 1 %}
        location ~ \.(hh|php)$ {
            #root /srv;
            fastcgi_index  index.php;
            fastcgi_keep_conn on;
            fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_pass unix:/var/run/{{ item.site }}.sock;
            fastcgi_param  HTTPS on;
            include        fastcgi_params;
        }

        {% endif %}
        {%  if item.nginx.wordpress == 1  %}
        rewrite ^/sitemap.xml$ /index.php last;
        rewrite ^/news-sitemap.xml$ /index.php last;
        ### Prevent public access for Wordpress internals
        location ~* wp-admin/includes { deny all; }
        location ~* wp-includes/theme-compat/ { deny all; }
        location ~* wp-includes/js/tinymce/langs/.*\.php { deny all; }
        location ~* (/\.|wp-config\.php|(liesmich|readme).*) {
            return 444;
        }

        # Disable direct access of any *.php files in /wp_includes folder
        location ~ ^/wp-includes/.+\.php$ {
            return 444;
        }

        # Disable direct access of any *.php in /wp_content folder
          location ~ ^/wp-content/.+\.php$ {
          return 444;
        }

        # Disable direct access of any *.php in /wp_content/uploads folder
          location ~ ^/wp-content/uploads/.+\.php$ {
          return 444;
        }
  
        location ~ ^/files/(.*)$ {
            alias /home/{{ item.site }}/wp-content/uploads/$1;
            expires max;
            add_header Pragma public;
            add_header Cache-Control "max-age=31536000, public";
        }
        
        location ~ ^/cache/(.*)$ {
            alias /home/{{ item.site }}/wp-content/cache/autoptimize/$1;
            expires max;
            add_header Pragma public;
            add_header Cache-Control "max-age=31536000, public";        
        }
        
        location ~ ^/assets/(.*)$ {
            alias /home/{{ item.site }}/wp-content/$1;   
            expires max;
            add_header Pragma public;
            add_header Cache-Control "max-age=31536000, public";    
            add_header Access-Control-Allow-Origin "*";
        }     
  
        location ~ ^/files/(.*)$ {
            alias /home/{{ item.site }}/wp-content/uploads/$server_name/$1;
            expires max;
            add_header Pragma public;
            add_header Cache-Control "max-age=31536000, public";
        }
        
        location ~ ^/cache/(.*)$ {
            alias /home/{{ item.site }}/wp-content/cache/autoptimize/$http_host/$1;
            expires max;
            add_header Pragma public;
            add_header Cache-Control "max-age=31536000, public";        
        }
        
        location ~ ^/assets/(.*)$ {
            alias /home/{{ item.site }}/wp-content/$1;   
            expires max;
            add_header Pragma public;
            add_header Cache-Control "max-age=31536000, public";    
            add_header Access-Control-Allow-Origin "*";
        }    
 
        {% endif %}  

        # Rewrite for versioned CSS+JS via filemtime
        location ~* ^.+\.(css|js)$ {
            gzip on;
            expires max;
            add_header Pragma public;
            add_header Cache-Control "max-age=31536000, public";
        }
        
        # Aggressive caching for static files
        # If you alter static files often, please use 
        # add_header Cache-Control "max-age=31536000, public, must-revalidate, proxy-revalidate";
        #location ~* \.(asf|asx|wax|wmv|wmx|avi|bmp|class|divx|doc|docx|eot|exe|gif|gz|gzip|ico|jpg|jpeg|jpe|mdb|mid|midi|mov|qt|mp3|m4a|mp4|m4v|mpeg|mpg|mpe|mpp|odb|odc|odf|odg|odp|ods|odt|ogg|ogv|otf pdf|png|pot|pps|ppt|pptx|ra|ram|svg|svgz|swf|tar|t?gz|tif|tiff|ttf|wav|webm|wma|woff|wri|xla|xls|xlsx|xlt|xlw|xml|zip)$ {
        #    gzip on;
        #    expires max;
        #    add_header Pragma public;
        #    add_header Cache-Control "max-age=31536000, public";
        #}
        
        # location /robots.txt {
        #     echo "User-agent: *";
        #     echo "Disallow: /";
        #     add_header  X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";
        # }
        
        location = /favicon.ico {
            log_not_found           off;
        }
        
        # Error pages must have properly set http headers!
        ##error_page 500 501 504 /overload/500;
        #error_page 502 503 /maintenance/502;
        
        location /overload {
            rewrite ^\/(.+)$ /overload/?pk_campaign=$server_name break;
            proxy_pass https://sbaerlo.ch;
            add_header Access-Control-Allow-Origin *;
            add_header  X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";
        }
        
        location /maintenance {
            rewrite ^\/(.+)$ /maintenance/?pk_campaign=$server_name break;
            proxy_pass https://sbaerlo.ch;
            add_header Access-Control-Allow-Origin *;
            add_header  X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";
        }
        
        # custom error pages
        #error_page 403 /error/403;
        #error_page 404 /error/404;
        #error_page 405 /error/405;
        
        location /error {
            rewrite ^\/(.+)$ /error/?pk_campaign=$server_name break;
            proxy_pass https://sbaerlo.ch;
            add_header Access-Control-Allow-Origin *;
            add_header  X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";
        }
    
}